---
import { Image } from "astro:assets";
import type { ImageMetadata } from "astro";

interface Slide {
    image: string | ImageMetadata;
    mobileImage?: string | ImageMetadata;
    alt: string;
}

interface Props {
    slides: Slide[];
    title: string;
    buttonText: string;
    buttonLink?: string;
    autoPlayInterval?: number; // en milisegundos, default: 5000
}

const { slides, title, buttonText, buttonLink = "#", autoPlayInterval = 5000 } = Astro.props;
---

<div class="slider-container relative w-full h-[calc(100vh-130px)] overflow-hidden">
    <!-- Slides -->
    <div class="slides-wrapper relative w-full h-full">
        {
            slides.map((slide, index) => (
                <div
                    class:list={[
                        "slide absolute inset-0 transition-opacity duration-[1500ms] ease-in-out",
                        index === 0 ? "opacity-100 z-10" : "opacity-0 z-0",
                    ]}
                    data-slide-index={index}
                >
                    {slide.mobileImage ? (
                        <picture class="w-full h-full">
                            {/* Imagen mobile */}
                            {typeof slide.mobileImage === "string" ? (
                                <source media="(max-width: 767px)" srcset={slide.mobileImage} />
                            ) : (
                                <source media="(max-width: 767px)" srcset={slide.mobileImage.src} />
                            )}
                            {/* Imagen desktop */}
                            {typeof slide.image === "string" ? (
                                <img
                                    src={slide.image}
                                    alt={slide.alt}
                                    class="w-full h-full object-cover"
                                />
                            ) : (
                                <Image
                                    src={slide.image}
                                    alt={slide.alt}
                                    class="w-full h-full object-cover"
                                    widths={[400, 800, 1200, 1600, 2000]}
                                    sizes="100vw"
                                    loading={index === 0 ? "eager" : "lazy"}
                                />
                            )}
                        </picture>
                    ) : typeof slide.image === "string" ? (
                        <img src={slide.image} alt={slide.alt} class="w-full h-full object-cover" />
                    ) : (
                        <Image
                            src={slide.image}
                            alt={slide.alt}
                            class="w-full h-full object-cover"
                            widths={[400, 800, 1200, 1600, 2000]}
                            sizes="100vw"
                            loading={index === 0 ? "eager" : "lazy"}
                        />
                    )}
                    <div class="absolute inset-0 bg-black/30" />
                </div>
            ))
        }
    </div>

    <!-- Contenido superpuesto -->
    <div
        class="absolute inset-0 z-20 flex flex-col items-start justify-center px-4 sm:px-6 md:px-12 lg:px-20"
    >
        <div class="container mx-auto">
            <h1
                class="text-3xl sm:text-4xl md:text-[44px] font-bold text-white mb-4 md:mb-8 max-w-[90vw] md:max-w-[700px] leading-tight md:leading-[52px] font-dunkel-expanded tracking-normal subpixel-antialiased"
            >
                {title}
            </h1>
            <a
                href={buttonLink}
                class="inline-block px-6 sm:px-8 py-3 border-2 border-white text-white font-medium rounded-full hover:bg-white hover:text-gray-900 active:bg-gray-100 transition-all duration-300 ease-in-out font-manrope text-base sm:text-lg md:text-[20px] min-h-[44px] flex items-center justify-center subpixel-antialiased"
            >
                {buttonText}
            </a>
        </div>
    </div>

    <!-- Indicadores de navegación (dots) - posicionados desde abajo -->
    <div
        class="absolute top-[65vh] left-0 right-0 z-20 px-4 sm:px-6 md:px-12 lg:px-20"
    >
        <div class="container mx-auto">
            <div class="flex gap-2 items-center">
                {
                    slides.map((_, index) => (
                        <button
                            class:list={[
                                "dot rounded-full transition-all duration-500 ease-in-out",
                                "h-2 md:h-3",
                                "p-1 md:p-0",
                                index === 0 ? "w-6 md:w-8 bg-white" : "w-2 md:w-3 bg-white/50",
                            ]}
                            data-dot-index={index}
                            aria-label={`Ir a la imagen ${index + 1}`}
                        />
                    ))
                }
            </div>
        </div>
    </div>
</div>

<script is:inline define:vars={{ autoPlayInterval }}>
    class Slider {
        constructor() {
            this.currentIndex = 0;
            this.slides = document.querySelectorAll(".slide");
            this.dots = document.querySelectorAll(".dot");
            this.container = document.querySelector(".slider-container");
            this.autoPlayTimer = null;
            this.isAutoPlayPaused = false;
            this.touchStartX = 0;
            this.touchEndX = 0;

            this.init();
        }

        init() {
            // Event listeners para los dots
            this.dots.forEach((dot, index) => {
                dot.addEventListener("click", () => {
                    this.goToSlide(index);
                    this.pauseAutoPlay();
                    this.restartAutoPlay();
                });
            });

            // Pausar autoplay al hacer hover (desktop)
            this.container.addEventListener("mouseenter", () => {
                this.pauseAutoPlay();
            });

            // Reanudar autoplay al salir del hover (desktop)
            this.container.addEventListener("mouseleave", () => {
                this.restartAutoPlay();
            });

            // Touch events para móviles
            this.container.addEventListener("touchstart", (e) => {
                this.touchStartX = e.changedTouches[0].screenX;
                this.pauseAutoPlay();
            });

            this.container.addEventListener("touchend", (e) => {
                this.touchEndX = e.changedTouches[0].screenX;
                this.handleSwipe();
                this.restartAutoPlay();
            });

            // Iniciar autoplay
            this.startAutoPlay();
        }

        handleSwipe() {
            const swipeThreshold = 50; // mínimo de píxeles para considerar un swipe
            const diff = this.touchStartX - this.touchEndX;

            if (Math.abs(diff) > swipeThreshold) {
                if (diff > 0) {
                    // Swipe izquierda - siguiente slide
                    this.nextSlide();
                } else {
                    // Swipe derecha - slide anterior
                    this.prevSlide();
                }
            }
        }

        prevSlide() {
            const prevIndex = (this.currentIndex - 1 + this.slides.length) % this.slides.length;
            this.goToSlide(prevIndex);
        }

        goToSlide(index) {
            // Ocultar slide actual
            this.slides[this.currentIndex].classList.remove("opacity-100", "z-10");
            this.slides[this.currentIndex].classList.add("opacity-0", "z-0");

            // Desactivar dot actual (hacerlo más pequeño)
            this.dots[this.currentIndex].classList.remove("bg-white", "w-6", "md:w-8");
            this.dots[this.currentIndex].classList.add("bg-white/50", "w-2", "md:w-3");

            // Actualizar índice
            this.currentIndex = index;

            // Mostrar nuevo slide
            this.slides[this.currentIndex].classList.remove("opacity-0", "z-0");
            this.slides[this.currentIndex].classList.add("opacity-100", "z-10");

            // Activar nuevo dot (hacerlo más ancho)
            this.dots[this.currentIndex].classList.remove("bg-white/50", "w-2", "md:w-3");
            this.dots[this.currentIndex].classList.add("bg-white", "w-6", "md:w-8");
        }

        nextSlide() {
            const nextIndex = (this.currentIndex + 1) % this.slides.length;
            this.goToSlide(nextIndex);
        }

        startAutoPlay() {
            this.autoPlayTimer = setInterval(() => {
                if (!this.isAutoPlayPaused) {
                    this.nextSlide();
                }
            }, autoPlayInterval);
        }

        pauseAutoPlay() {
            this.isAutoPlayPaused = true;
        }

        restartAutoPlay() {
            this.isAutoPlayPaused = false;
        }
    }

    // Inicializar slider cuando el DOM esté listo
    if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", () => {
            new Slider();
        });
    } else {
        new Slider();
    }
</script>
